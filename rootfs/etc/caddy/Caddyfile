{
  local_certs
  # Disable auto_https redirects since we don't want permanent redirects to https
  auto_https disable_redirects
}

(log) {
  log {
    output {$LOG_OUTPUT}
  }
}

(cors) {
  @options method OPTIONS
  handle @options {
    header ?Access-Control-Max-Age {$CORS_MAX_AGE}
    header ?Access-Control-Allow-Headers {$CORS_HEADERS}
    header ?Access-Control-Allow-Methods {$CORS_METHODS}
    respond 204
  }
  header ?Access-Control-Allow-Origin {header.origin}
}

# Redirect http to https
http://, https:// {
  redir https://{$SITE_ADDRESS}{uri}
  tls {
    on_demand
  }
}

http://{$SITE_ADDRESS}, http://*.{$SITE_ADDRESS} {
  redir https://{host}{uri} permanent
}

# Redirect www domains to the app
www.{$SITE_ADDRESS} {
  redir https://{$SITE_ADDRESS}{uri}
}

# App
{$SITE_ADDRESS}, *.{$SITE_ADDRESS} {
  import cors
  reverse_proxy /socket.io/* {$SOCKETIO_ADDRESS}
  reverse_proxy {$APP_ADDRESS}
  import log
}

# API
api.{$SITE_ADDRESS} {
  import cors
  reverse_proxy {$API_ADDRESS}
  import log
}

# Local SMTP
mail.{$SITE_ADDRESS} {
  reverse_proxy {$MAIL_ADDRESS}
  import log
}
